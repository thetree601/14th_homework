# 비밀 등록 기능 완성 및 이미지 미리보기 기능 추가

## 목표
등록 페이지에서 비밀을 등록하면 실제로 Supabase에 저장되고, 상세 페이지에서 바로 조회할 수 있도록 하며, 이미지 업로드 시 사용자가 선택한 이미지를 미리 확인할 수 있는 기능을 추가합니다.

## 요구사항

### 1. 등록 기능 완성 확인
- 위치: `/src/components/secrets-new/index.tsx`
- 현재 `createSecret` 함수를 호출하여 실제 등록이 이루어지고 있는지 확인
- 등록 성공 시 적절한 피드백 제공 (성공 메시지, 에러 처리 등)
- 등록 성공 후 목록 페이지로 이동하는지 확인

### 2. 상세 페이지 fetch 확인 및 개선
- 위치: `/src/app/secrets/[secretId]/page.tsx`
- 등록된 비밀이 상세 페이지에서 정상적으로 조회되는지 확인
- `fetchSecretById` 함수가 올바르게 작동하는지 확인
- 데이터가 없을 경우 404 페이지 표시 확인
- 로딩 상태 처리 확인

### 3. 이미지 미리보기 기능 추가
- 위치: `/src/components/secrets-form/index.tsx`
- 사용자가 이미지를 선택하면 즉시 미리보기를 표시
- FileReader API를 사용하여 임시 URL 생성 (`URL.createObjectURL` 또는 `FileReader.readAsDataURL`)
- 미리보기 이미지 표시 영역 추가
- 이미지 선택 취소 기능 (미리보기 제거)
- 기존 이미지가 있는 경우 (수정 모드) 기존 이미지도 표시

#### 구현 세부사항
- `useState`로 선택된 이미지의 미리보기 URL 관리
- `useEffect`로 파일 선택 시 미리보기 URL 생성
- 컴포넌트 언마운트 시 `URL.revokeObjectURL`로 메모리 정리
- 미리보기 이미지가 있을 때는 업로드 박스 대신 이미지 표시
- 이미지 변경 버튼 제공 (다시 선택할 수 있도록)

### 4. Supabase 테이블 업데이트 필요 사항 확인
- 현재 `secrets` 테이블 구조 확인
- 필요한 컬럼이 모두 있는지 확인:
  - `id` (UUID, 자동 생성)
  - `title` (text, NOT NULL)
  - `desc` (text, NOT NULL) - 메인 페이지용 한줄 설명
  - `description` (text, nullable) - 상세 페이지용 설명 (현재는 사용 안 함)
  - `intro` (text, nullable) - 상세 페이지 본문
  - `price` (integer/numeric, NOT NULL)
  - `img` (text, nullable) - 이미지 URL
  - `category` (text, NOT NULL) - 기본값 'sale'
  - `tags` (text[] 또는 jsonb, nullable)
  - `address`, `postal_code`, `address_detail` (text, nullable)
  - `latitude`, `longitude` (numeric, nullable)
  - `sale_ends` (timestamp, nullable)
  - `created_at`, `updated_at` (timestamp, 자동 생성)

#### 확인 및 수정 필요 사항
- `category` 컬럼: 기본값은 'hot'이지만 코드에서 명시적으로 'sale'로 설정하므로 문제없음 (NOT NULL 확인됨)
- `desc` 컬럼: NOT NULL 확인됨, 폼에서 필수 입력이므로 문제없음
- `price` 컬럼: int4 (integer) 타입으로 적절함
- `tags` 컬럼: jsonb 타입으로 배열 지원 확인됨
- `img` 컬럼: nullable로 변경됨 (이미지 없이도 등록 가능)
- RLS (Row Level Security) 정책: 읽기는 모두 허용, 쓰기는 로그인한 사용자만 허용으로 설정됨
- Storage bucket: `secrets-images` bucket 생성 완료, public으로 설정 필요 (코드에서 bucket 이름을 `'secrets-images'`로 변경 필요)

### 5. 이미지 업로드 개선
- 위치: `/src/components/secrets-list/mutations.ts`
- `uploadImageToSupabase` 함수의 bucket 이름을 `'images'`에서 `'secrets-images'`로 변경 필요
- 이미지 업로드 실패 시 적절한 에러 처리
- 이미지 파일 크기 제한 확인 (5MB 이하 권장)
- 이미지 파일 형식 제한 확인 (jpeg, png 등)
- Supabase Storage bucket `secrets-images`가 public으로 설정되어 있는지 확인

## 구현 순서

1. **Supabase 테이블 구조 확인 및 업데이트**
   - Supabase 대시보드에서 `secrets` 테이블 구조 확인 완료
   - 모든 필요한 컬럼 존재 확인됨
   - 제약 조건 및 기본값 설정 확인 완료
   - Storage bucket `secrets-images` 생성 완료, public 설정 확인 필요
   - 코드에서 bucket 이름을 `'secrets-images'`로 변경 필요

2. **등록 기능 테스트**
   - 실제 등록이 되는지 확인
   - 등록 후 상세 페이지에서 조회되는지 확인
   - 에러 케이스 처리 확인

3. **이미지 미리보기 기능 구현**
   - FileReader API를 사용한 미리보기 URL 생성
   - 미리보기 이미지 표시 UI 추가
   - 이미지 변경/제거 기능 추가
   - 메모리 정리 (URL.revokeObjectURL)

4. **전체 플로우 테스트**
   - 등록 → 상세 페이지 조회 → 이미지 표시 확인
   - 이미지 미리보기 → 등록 → 상세 페이지 이미지 확인

## 참고사항
- FileReader API는 브라우저 호환성을 고려해야 함
- 큰 이미지 파일의 경우 메모리 사용량 주의
- Supabase Storage bucket 이름: `secrets-images` (코드에서 반영 필요)
- 이미지 업로드 실패 시 사용자에게 명확한 에러 메시지 제공
- 테이블 구조: category 기본값 'hot'이지만 코드에서 'sale'로 설정하므로 문제없음
- desc는 NOT NULL이고 폼에서 필수이므로 문제없음
- price는 int4, tags는 jsonb로 적절함
- img는 nullable로 변경 완료

