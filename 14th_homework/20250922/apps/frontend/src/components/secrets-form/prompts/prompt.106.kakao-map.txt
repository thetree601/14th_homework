# 비밀 등록/수정 페이지에 카카오 지도 연동 기능 추가

## 목표
주소 입력 시 해당 좌표를 카카오 지도에 표시하고, 마커로 위치를 보여주는 기능을 구현합니다.

## 요구사항

### 1. 카카오 지도 API 스크립트 로드
- 위치: `/src/components/secrets-form/index.tsx`
- Next.js의 `Script` 컴포넌트를 사용하여 카카오 지도 API 스크립트를 로드합니다.
- 카카오 지도 API 키는 환경 변수(`NEXT_PUBLIC_KAKAO_MAP_API_KEY`)에서 가져옵니다.
- **카카오 지도 JavaScript 키**: `f9a89aef673fd594f7fef9f9892d883f`
- 스크립트는 `useEffect`를 사용하여 컴포넌트 마운트 시 로드합니다.
- 스크립트 로드 완료 후 지도 초기화 함수를 호출합니다.
- 스크립트 URL: `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${API_KEY}&libraries=services&autoload=false`
- **중요**: `libraries=services` 파라미터를 반드시 포함해야 합니다. 이 파라미터가 없으면 지도 API가 제대로 로드되지 않을 수 있습니다.

### 2. 지도 표시 영역 추가
- 위치: `/src/components/secrets-form/index.tsx` (주소 입력 필드 아래)
- 위치: `/src/components/secrets-form/styles.module.css` (지도 스타일)
- 주소 입력 필드 아래에 지도를 표시할 영역(`<div id="map">`)을 추가합니다.
- 지도는 주소가 입력되었을 때만 표시됩니다 (조건부 렌더링).
- 지도 컨테이너의 높이는 400px로 설정합니다.
- 지도 컨테이너는 반응형으로 구현합니다 (모바일에서는 높이 조정).

### 3. 주소 → 좌표 변환 (Geocoding)
- 위치: `/src/components/secrets-form/index.tsx`
- 카카오 지도 Geocoder API를 사용하여 주소를 좌표로 변환합니다.
- `handleCompletePostcode` 함수에서 주소가 설정된 후:
  1. Geocoder를 사용하여 주소를 좌표로 변환
  2. 변환된 좌표를 `latitude`와 `longitude` 필드에 자동으로 설정
  3. 지도를 해당 좌표로 이동시키고 마커 표시
- 주소가 수동으로 입력된 경우에도 동일하게 처리합니다 (`address` 필드의 `onChange` 이벤트 감지).

### 4. 지도 초기화 및 마커 표시
- 위치: `/src/components/secrets-form/index.tsx`
- `useEffect`를 사용하여:
  1. 카카오 지도 API가 로드되었는지 확인
  2. 주소와 좌표가 모두 있을 때 지도를 초기화
  3. 지도 중심을 해당 좌표로 설정
  4. 해당 위치에 마커를 표시
- 지도 초기화는 `useRef`를 사용하여 지도 인스턴스를 저장합니다.
- 마커는 커스텀 이미지를 사용하거나 기본 마커를 사용합니다.

### 5. 좌표 변경 시 지도 업데이트
- 위치: `/src/components/secrets-form/index.tsx`
- `latitude` 또는 `longitude` 필드가 수동으로 변경되면:
  1. 새로운 좌표로 지도 중심 이동
  2. 기존 마커 제거 후 새로운 위치에 마커 표시
- `watch`를 사용하여 좌표 필드 변경을 감지합니다.

### 6. 지도 스타일링
- 위치: `/src/components/secrets-form/styles.module.css`
- 지도 컨테이너 스타일:
  - 배경: `#1b1b1b` (기존 폼 스타일과 일치)
  - 테두리: `1px solid rgba(199, 167, 74, 0.2)` (기존 폼 스타일과 일치)
  - 테두리 반경: `12px`
  - 오버플로우: `hidden`
- 지도가 표시되지 않을 때는 영역을 숨깁니다.

## 구현 세부사항

### 카카오 지도 API 스크립트 로드
```typescript
// Script 컴포넌트 import
import Script from 'next/script';

// 카카오 지도 API 키 (환경 변수 또는 직접 사용)
const KAKAO_MAP_API_KEY = process.env.NEXT_PUBLIC_KAKAO_MAP_API_KEY || 'f9a89aef673fd594f7fef9f9892d883f';

// 컴포넌트 내부에서 Script 컴포넌트 사용
<Script
  src={`https://dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_MAP_API_KEY}&libraries=services&autoload=false`}
  strategy="lazyOnload"
  onLoad={() => {
    if (window.kakao && window.kakao.maps) {
      window.kakao.maps.load(() => {
        // 지도 초기화 로직
      });
    }
  }}
/>

// 또는 useEffect에서 스크립트 로드 확인
useEffect(() => {
  if (typeof window !== 'undefined' && window.kakao && window.kakao.maps) {
    window.kakao.maps.load(() => {
      // 지도 초기화 로직
    });
  }
}, []);
```

### Geocoding 함수
```typescript
const geocodeAddress = (address: string) => {
  if (!window.kakao || !window.kakao.maps) return;
  
  const geocoder = new window.kakao.maps.services.Geocoder();
  geocoder.addressSearch(address, (result: any, status: any) => {
    if (status === window.kakao.maps.services.Status.OK) {
      const coords = new window.kakao.maps.LatLng(result[0].y, result[0].x);
      setValue('latitude', result[0].y);
      setValue('longitude', result[0].x);
      // 지도 업데이트
    }
  });
};
```

### 지도 초기화 함수
```typescript
const initMap = (latitude: number, longitude: number) => {
  if (!window.kakao || !window.kakao.maps) return;
  
  const container = document.getElementById('map');
  if (!container) return;
  
  const options = {
    center: new window.kakao.maps.LatLng(latitude, longitude),
    level: 3
  };
  
  const map = new window.kakao.maps.Map(container, options);
  
  // 마커 표시
  const markerPosition = new window.kakao.maps.LatLng(latitude, longitude);
  const marker = new window.kakao.maps.Marker({
    position: markerPosition
  });
  marker.setMap(map);
};
```

### 주소 입력 완료 핸들러 수정
```typescript
const handleCompletePostcode = (data: any) => {
  setValue("postalCode", data.zonecode);
  setValue("address", data.address);
  setIsPostcodeModalOpen(false);
  
  // 주소를 좌표로 변환
  geocodeAddress(data.address);
};
```

### 좌표 필드 변경 감지
```typescript
const watchedLatitude = watch("latitude");
const watchedLongitude = watch("longitude");
const watchedAddress = watch("address");

useEffect(() => {
  if (watchedLatitude && watchedLongitude) {
    const lat = parseFloat(watchedLatitude);
    const lng = parseFloat(watchedLongitude);
    if (!isNaN(lat) && !isNaN(lng)) {
      initMap(lat, lng);
    }
  }
}, [watchedLatitude, watchedLongitude]);
```

## 파일 구조
```
src/
├── components/
│   └── secrets-form/
│       ├── index.tsx          # 카카오 지도 연동 로직 추가
│       ├── styles.module.css  # 지도 스타일 추가
│       └── prompts/
│           └── prompt.106.kakao-map.txt
```

## 참고사항
- **카카오 지도 JavaScript 키**: `f9a89aef673fd594f7fef9f9892d883f`
- 카카오 지도 API 키는 `.env.local` 파일에 다음과 같이 설정하는 것을 권장합니다:
  ```
  NEXT_PUBLIC_KAKAO_MAP_API_KEY=f9a89aef673fd594f7fef9f9892d883f
  ```
- 환경 변수가 설정되지 않은 경우, 코드에서 직접 키를 사용할 수 있습니다 (개발 환경에서만).
- 카카오 지도 API는 웹 플랫폼에서 사용 가능합니다.
- Geocoder API는 무료로 사용 가능하지만, 일일 호출 제한이 있을 수 있습니다.
- 지도는 주소가 입력되고 좌표가 설정되었을 때만 표시됩니다.
- 기존 주소 검색 기능(`DaumPostcode`)은 그대로 유지합니다.
- 수정 모드에서 기존 주소와 좌표가 있으면 자동으로 지도에 표시됩니다.
- 카카오 지도 API 스크립트는 `autoload=false` 옵션을 사용하여 수동으로 로드합니다.
- **중요**: 스크립트 URL에 `libraries=services` 파라미터를 반드시 포함해야 합니다. 이 파라미터가 없으면 지도 API가 제대로 로드되지 않을 수 있습니다.

## 타입 정의
```typescript
// window 객체에 kakao 타입 추가
declare global {
  interface Window {
    kakao: any;
  }
}
```

